!function(e){var t=e.fn.fancy_input,s=e.fn.fancy_suggest=function(t){var l=e.extend({},s.default_options,t);return this.each(function(){var t=e(this);s.init_suggest(t,l),t.focus(function(){s.attach_suggest_box(t,l),t.val().length>0&&s.setTimeout(function(){s.suggest(t,l)},l.delay)}).blur(function(){s.hide()}).keydown(function(e){switch(e.keyCode){case s.keys.ARROW_UP:return s.select_prev(t,l),!1;case s.keys.ARROW_DOWN:return s.select_next(t,l),!1;case s.keys.ESC:s.clear(t,l);break;case s.keys.RETURN:if(null!==s.selected_result)return s.activate_selected(t,l),!1}}).keyup(function(e){var i=e.keyCode;s.align_suggest_box(t,l),(i>s.keys.SPECIALS_END||i==s.keys.BACKSPACE||i==s.keys.DELETE)&&(s.clearTimeout(),s.suggest(t,l))})})};e.extend(s,t,{box:null,list:null,attached_to:null,current_results:[],selected_result:null,query_cache:[],default_options:e.extend({},t.default_options,{name:"",exact_match:!0,limit:6,no_results:!0,no_results_label:"No Results",url:null,url_method:"get",url_query_var:"search",pos_top:0,pos_left:0,hide_delay:0,data:null,min_length:4,tpl_container_id:"fancy_suggest",tpl_container_class:"fancy_suggest",tpl_container:'<div id="{{id}}"><ol></ol></div>',tpl_result_begin:'<li class="result {{class}}" id="{{id}}" result_id="{{result_id}}"><a href="{{href}}">',tpl_result_body:'<span class="title">{{title}}</span>',tpl_result_end:"</a></li>",tpl_label:'<li class="label {{class}}">{{label}}</li>',tpl_highlight:'<b class="highlight">$1</b>'}),init_suggest:function(t,s){this.box=e("#"+s.tpl_container_id),0==this.box.length&&(e("body").append(e(s.tpl_container).attr("id",s.tpl_container_id).attr("class",s.tpl_container_class)),this.box=e("#"+s.tpl_container_id)),this.list=this.box.children("ol")},attach_suggest_box:function(e,t){var s=this.elm_uid(e);this.align_suggest_box(e,t),s!==this.attached_to&&("string"==typeof t.name&&""!=t.name&&this.box.hide().addClass(t.name),this.attached_to=s)},align_suggest_box:function(e,t){var s=e.offset();this.box.css("left",s.left+t.pos_left);var l=s.top+e.innerHeight();if(l+=parseInt(e.css("border-top-width"),10)+parseInt(e.css("border-bottom-width"),10),l+=t.pos_top,this.box.css("top",l),"number"==typeof t.width||"string"==typeof t.width&&""!=t.width)this.box.css("width",t.width);else{var i=e.innerWidth();i+=parseInt(e.css("border-left-width"),10)+parseInt(e.css("border-right-width"),10),i-=parseInt(this.box.css("border-left-width"),10)+parseInt(this.box.css("border-right-width"),10),this.box.css("width",i)}},suggest:function(t,s){var l=e.trim(this.get_value(t,s));s.exact_match&&(l=l.split(/\s/)),("string"==typeof l&&""!=l||"object"==typeof l&&l.length>0)&&(this.selected_result=null,"string"==typeof s.url&&""!==s.url?this.query_for_data(t,s):(this.current_results=this.filter_data(l,s.data,s),this.prerender(t,this.current_results,s)))},filter_data:function(e,t,s){"string"==typeof e&&(e=[e]);for(var l="",i=[],r=e.length,n=0;r>n;n++){var u=e[n];if(u=u.toLowerCase(),null!==t&&"undefined"!=typeof u&&""!==u)for(var a=t.length,c=0;a>c;c++){var h=t[c].title.toLowerCase(),d="undefined"!=typeof t[c].match?t[c].match.toLowerCase():"";if((-1!==h.indexOf(u)||-1!==d.indexOf(u))&&-1==l.indexOf(":"+c+":")&&(i.push(t[c]),l+=":"+c+":",i.length>=s.limit))return i}}return i},query_for_data:function(t,s){var l=this.get_value(t,s),i=s.url+"?"+l+":"+s.limit;if(""!==l&&l.length>=s.min_length)if(this.query_cache.hasOwnProperty(i))this.current_results=this.query_cache[i],this.prerender(t,this.current_results,s);else{var r={limit:s.limit};r[s.url_query_var]=l;var n=this;e.ajax({type:s.url_method,url:s.url,data:r,dataType:"json",success:function(e){n.current_results=e.results,n.query_cache[i]=n.current_results,n.prerender(t,n.current_results,s)}})}else this.no_results(t,s)},clear:function(e){this.set_value(e,""),this.hide(),this.selected_result=null},no_results:function(e,t){if(t.no_results&&""!==this.get_value(e,t)){var s={label:t.no_results_label,"class":"last"};this.list.html(this.mustache(t.tpl_label,s)),this.show()}else this.hide(0)},prerender:function(e,t,s){t.length>0?(this.render(e,t,s),this.show(),1==t.length&&this.select_next(e,s)):this.no_results(e,s)},render:function(t,s,l){for(var i=s.length,r="",n=0;i>n;n++){var u="fancy_suggest_result_"+n,a=e.extend({},s[n],{id:u,"class":"",result_id:n});0==n&&e.extend(a,{"class":"first"}),n==i-1&&e.extend(a,{"class":"last"}),a.title=a.title.replace(new RegExp("("+this.get_value(t,l)+")","ig"),l.tpl_highlight),r+=this.mustache(l.tpl_result_begin,a),r+=this.mustache(l.tpl_result_body,a),r+=this.mustache(l.tpl_result_end,a)}this.list.html(r);var c=this;e(".result a",this.list).mousedown(function(){c.selected_result=parseInt(e(this).parent().attr("result_id"),10),c.activate_selected(t,l)}).click(function(){return!1}),e(".result",this.list).hover(function(){e(".selected",c.list).removeClass("selected"),c.selected_result=e(this).addClass("selected").attr("result_id")},function(){e(this).removeClass("selected"),c.selected_result=null})},show:function(){this.box.show()},hide:function(t){"number"!=typeof t&&(t=this.default_options.hide_delay),this.selected_result=null;var s=this;this.setTimeout(function(){s.selected_result=null,e(".selected",this.list).removeClass("selected"),s.box.hide()},t)},select_next:function(t){var s=this.current_results.length,l="fancy_suggest_result_";return s>0&&(null===this.selected_result?(e(".selected",this.list).removeClass("selected"),this.selected_result=0,e("#"+l+this.selected_result).addClass("selected")):this.selected_result+1<s?(e(".selected",this.list).removeClass("selected"),this.selected_result++,e("#"+l+this.selected_result).addClass("selected")):(e(".selected",this.list).removeClass("selected"),this.selected_result=null,t.putCursorAtEnd())),!1},select_prev:function(t){var s=this.current_results.length,l="fancy_suggest_result_";return s>0&&(null===this.selected_result?(e(".selected",this.list).removeClass("selected"),this.selected_result=s-1,e("#"+l+this.selected_result).addClass("selected")):this.selected_result>0?(e(".selected",this.list).removeClass("selected"),this.selected_result--,e("#"+l+this.selected_result).addClass("selected")):(e(".selected",this.list).removeClass("selected"),this.selected_result=null,t.putCursorAtEnd())),!1},activate_selected:function(){null!==this.selected_result&&this.redirect_to(this.current_results[this.selected_result].href)},get_value:function(e){return e.val()},set_value:function(e,t){e.val(t)}})}(jQuery);
